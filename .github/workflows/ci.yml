name: Continuous integration
on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-20.04
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          # Install tools used by `_tools/format.sh`.
          sudo apt-get -qq update
          sudo apt-get -qq install dos2unix recode
          sudo pip3 install -r requirements.txt
          sudo pip3 install codespell

      - name: Linter checks
        run: |
          bash _tools/format.sh
          codespell -I _tools/codespell-ignore.txt -x _tools/codespell-ignore-lines.txt {about,community,development,getting_started,tutorials}/**/*.rst

      - name: Sphinx build
        run: |
          # On godotengine, use dummy builder to improve performance as we don't need the generated HTML in this workflow.
          # On forks, build the HTML site, to push it to gh-pages.
          case '${{ github.repository }}' in
            godotengine/godot-docs) TARGET='dummy';;
            *) TARGET='html';;
          esac
          make SPHINXOPTS='--color -W' "$TARGET"

      - name: ðŸš€ Publish site to GitHub Pages
        if: github.repository != 'godotengine/godot-docs'
        run: |
          cd _build/html
          touch .nojekyll
          git init
          cp ../../.git/config ./.git/config
          git add .
          git config --local user.email "gotdot-docs@GitHubActions"
          git config --local user.name "GitHub Actions"
          git commit -a -m "update ${{ github.sha }}"
          git push -u origin +HEAD:gh-pages
